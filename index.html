<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ICD Code Parser</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>ICD Code Parser</h1>
  <textarea id="input" placeholder="G30.9 (Alzheimer disease, unspecified), S06.2X9S (Diffuse traumatic brain injury (with loss of consciousness), sequela)" aria-label="ICD code input"></textarea>
  <div class="button-group">
    <button onclick="convert()">Convert to JSON</button>
    <button onclick="extractCodes()">Extract Codes</button>
  </div>
  <h2>Result</h2>
  <pre id="output">{}</pre>
  <div id="copy-wrapper">
    <button onclick="copyToClipboard()">üìã Copy</button>
    <span id="copied">Copied!</span>
  </div>
  <script>
    function parseICDCodes(input) {

      // -----------------------------
      // –ù–û–†–ú–ê–õ–ò–ó–ê–¶–ò–Ø (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∫–∏)
      // -----------------------------

      const cleaned = input
        .replace(/\r\n?/g, '\n')          // FIX: –Ω–æ—Ä–º–∞–ª—å–Ω–∞—è –∑–∞–º–µ–Ω–∞ –ø–µ—Ä–µ–Ω–æ—Å–æ–≤
        .replace(/\\"/g, '"')             // FIX: –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –∑–∞–º–µ–Ω–∞ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–∞–≤—ã—á–µ–∫, –∞ –Ω–µ –≤—Å–µ—Ö –∫–∞–≤—ã—á–µ–∫ –ø–æ–¥—Ä—è–¥
        .trim();

      // FIX: –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–ª–∏–Ω—É cleaned, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∞
      let i = 0;
      const len = cleaned.length;

      const codes = [];

      while (i < len) {

        // -----------------------------
        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏
        // -----------------------------
        while (i < len && /[\s,;\n]/.test(cleaned[i])) i++; // FIX: —É–±—Ä–∞–Ω –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã–π '\\'
        if (i >= len) break;

        // -----------------------------
        // –ü–∞—Ä—Å–∏–º –∫–æ–¥: –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –±—É–∫–≤—ã, —Å–æ–¥–µ—Ä–∂–∏—Ç —Ö–æ—Ç—è –±—ã 1 —Ü–∏—Ñ—Ä—É
        // -----------------------------
        let codeStart = i;
        let hasDigit = false;

        if (/[A-Z]/.test(cleaned[i])) {
          i++; 
          while (i < len && /[A-Z0-9.]/.test(cleaned[i])) {
            if (/[0-9]/.test(cleaned[i])) hasDigit = true;
            i++;
          }
        }

        let code = cleaned.slice(codeStart, i).trim();
        if (!code || code.length < 2 || !hasDigit) { i++; continue; }

        // –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–±–µ–ª—ã
        while (i < len && /\s/.test(cleaned[i])) i++;

        // -----------------------------
        // –ü–∞—Ä—Å–∏–º —Ç–µ–∫—Å—Ç –≤ —Å–∫–æ–±–∫–∞—Ö
        // -----------------------------
        let text = '';

        if (i < len && cleaned[i] === '(') {
          let depth = 1;
          let textStart = ++i;
          let lastSepPos = -1;

          while (i < len && depth > 0) {
            let ch = cleaned[i];

            if (ch === '(') depth++;
            else if (ch === ')') depth--;

            // FIX: —Ç–æ–ª—å–∫–æ "–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ" —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏, –∑–∞–ø—è—Ç—É—é –≤–Ω—É—Ç—Ä–∏ –æ–ø–∏—Å–∞–Ω–∏—è –ù–ï —Ç—Ä–æ–≥–∞–µ–º
            if (/[;\n]/.test(ch)) lastSepPos = i; 

            i++;

            // -----------------------------
            // –≠–≤—Ä–∏—Å—Ç–∏–∫–∞: –æ–±–Ω–∞—Ä—É–∂–∏–ª–∏ –Ω–æ–≤—ã–π –∫–æ–¥ –≤–Ω—É—Ç—Ä–∏ —Å–∫–æ–±–æ–∫
            // -----------------------------
            if (depth > 0) {
              // FIX: –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–±–µ–ª—ã –ø–µ—Ä–µ–¥ –Ω–æ–≤–æ–π –±—É–∫–≤–æ–π (—Ç–≤–æ–π –ø—Ä–∏–º–µ—Ä –ª–æ–º–∞–ª—Å—è –∏–∑-–∑–∞ —ç—Ç–æ–≥–æ)
              let lookahead = i;
              while (lookahead < len && /\s/.test(cleaned[lookahead])) lookahead++;

              if (lookahead < len && /[A-Z]/.test(cleaned[lookahead])) {
                let tempI = lookahead + 1;
                let tempHasDigit = false;

                while (tempI < len && /[A-Z0-9.]/.test(cleaned[tempI])) {
                  if (/[0-9]/.test(cleaned[tempI])) tempHasDigit = true;
                  tempI++;
                }

                if (tempI - lookahead >= 3 && tempHasDigit) {
                  // FIX: –Ω–µ —Ä–µ–∂–µ–º –ø–æ –∑–∞–ø—è—Ç–æ–π –≤–Ω—É—Ç—Ä–∏ —Ç–µ–∫—Å—Ç–∞, —Ç–æ–ª—å–∫–æ –ø–æ ; –∏–ª–∏ –ø–µ—Ä–µ–Ω–æ—Å—É
                  if (lastSepPos >= textStart) {
                    text = cleaned.slice(textStart, lastSepPos).trim();
                    i = lastSepPos;
                  }
                  break;
                }
              }
            }
          }

          if (!text) {
            text = cleaned.slice(textStart, depth === 0 ? i - 1 : i).trim();
          }
        }

        codes.push({ code, text });
      }

      return codes;
    }

    function convert() {
      const inputElement = document.getElementById('input');
      const outputElement = document.getElementById('output');
      const copiedElement = document.getElementById('copied');
      
      const input = inputElement.value.trim();
      const codes = parseICDCodes(input);
      
      outputElement.textContent = JSON.stringify({ codes }, null, 2);
      copiedElement.style.display = 'none';
    }
    
    function extractCodes() {
      const inputElement = document.getElementById('input');
      const outputElement = document.getElementById('output');
      const copiedElement = document.getElementById('copied');
      
      const input = inputElement.value.trim();
      const codes = parseICDCodes(input).map(c => c.code);
      
      outputElement.textContent = JSON.stringify(codes, null, 2);
      copiedElement.style.display = 'none';
    }
    
    function copyToClipboard() {
      const outputElement = document.getElementById('output');
      const copiedElement = document.getElementById('copied');
      
      navigator.clipboard.writeText(outputElement.textContent).then(() => {
        copiedElement.style.display = 'inline';
        setTimeout(() => {
          copiedElement.style.display = 'none';
        }, 1000);
      })
    }
  </script>
</body>
</html>
