<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ICD Code Parser</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <h1>ICD Code Parser</h1>
    <textarea
      id="input"
      placeholder="G30.9 (Alzheimer disease, unspecified), S06.2X9S (Diffuse traumatic brain injury (with loss of consciousness), sequela)"
      aria-label="ICD code input"
    ></textarea>
    <div class="button-group">
      <button onclick="convert()">Convert to JSON</button>
      <button onclick="extractCodes()">Extract Codes</button>
    </div>
    <h2>Result</h2>
    <pre id="output">{}</pre>
    <div id="copy-wrapper">
      <button onclick="copyToClipboard()">ðŸ“‹ Copy</button>
      <span id="copied">Copied!</span>
    </div>
    <script>
      function parseICDCodes(input) {
        const cleaned = input
          .replace(/\r\n?/g, "\n")
          .replace(/\\"/g, '"')
          .trim();

        let i = 0;
        const len = cleaned.length;

        const codes = [];

        while (i < len) {
          while (i < len && /[\s,;\n]/.test(cleaned[i])) i++;
          if (i >= len) break;

          let codeStart = i;
          let hasDigit = false;

          if (/[A-Z0-9]/.test(cleaned[i])) {
            if (/[0-9]/.test(cleaned[i])) hasDigit = true;
            i++;
            while (i < len && /[A-Z0-9.]/.test(cleaned[i])) {
              if (/[0-9]/.test(cleaned[i])) hasDigit = true;
              i++;
            }
          }

          let code = cleaned.slice(codeStart, i).trim();
          if (!code || code.length < 2 || !hasDigit) {
            i++;
            continue;
          }

          while (i < len && /\s/.test(cleaned[i])) i++;
          let text = "";

          if (i < len && cleaned[i] === "(") {
            let depth = 1;
            let textStart = ++i;
            let lastSepPos = -1;

            while (i < len && depth > 0) {
              let ch = cleaned[i];

              if (ch === "(") depth++;
              else if (ch === ")") depth--;

              if (/[;\n]/.test(ch)) lastSepPos = i;

              i++;
              if (depth > 0) {
                let lookahead = i;
                while (lookahead < len && /\s/.test(cleaned[lookahead]))
                  lookahead++;

                if (lookahead < len && /[A-Z]/.test(cleaned[lookahead])) {
                  let tempI = lookahead + 1;
                  let tempHasDigit = false;

                  while (tempI < len && /[A-Z0-9.]/.test(cleaned[tempI])) {
                    if (/[0-9]/.test(cleaned[tempI])) tempHasDigit = true;
                    tempI++;
                  }

                  if (tempI - lookahead >= 3 && tempHasDigit) {
                    if (lastSepPos >= textStart) {
                      text = cleaned.slice(textStart, lastSepPos).trim();
                      i = lastSepPos;
                    }
                    break;
                  }
                }
              }
            }

            if (!text) {
              text = cleaned.slice(textStart, depth === 0 ? i - 1 : i).trim();
            }
          }

          codes.push({ code, text });
        }

        return codes;
      }

      function convert() {
        const inputElement = document.getElementById("input");
        const outputElement = document.getElementById("output");
        const copiedElement = document.getElementById("copied");

        const input = inputElement.value.trim();
        const codes = parseICDCodes(input);

        outputElement.textContent = JSON.stringify({ codes }, null, 2);
        copiedElement.style.display = "none";
      }

      function extractCodes() {
        const inputElement = document.getElementById("input");
        const outputElement = document.getElementById("output");
        const copiedElement = document.getElementById("copied");

        const input = inputElement.value.trim();
        const codes = parseICDCodes(input).map((c) => c.code);

        outputElement.textContent = JSON.stringify(codes, null, 2);
        copiedElement.style.display = "none";
      }

      function copyToClipboard() {
        const outputElement = document.getElementById("output");
        const copiedElement = document.getElementById("copied");

        navigator.clipboard.writeText(outputElement.textContent).then(() => {
          copiedElement.style.display = "inline";
          setTimeout(() => {
            copiedElement.style.display = "none";
          }, 1000);
        });
      }
    </script>
  </body>
</html>
